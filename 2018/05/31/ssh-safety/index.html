<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ssh安全加固 | Peithon&#39;s Blog</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="每一台服务器基本都会配置ssh服务，但是如果我们不对ssh进行安全防护，就相当于给入侵者提供了一个入侵途径。所以对ssh进行一些安全配置十分重要。">
<meta name="keywords" content="密钥登录,ssh安全加固">
<meta property="og:type" content="article">
<meta property="og:title" content="ssh安全加固">
<meta property="og:url" content="http://yoursite.com/2018/05/31/ssh-safety/index.html">
<meta property="og:site_name" content="Peithon&#39;s Blog">
<meta property="og:description" content="每一台服务器基本都会配置ssh服务，但是如果我们不对ssh进行安全防护，就相当于给入侵者提供了一个入侵途径。所以对ssh进行一些安全配置十分重要。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://p8urkh0xe.bkt.clouddn.com/18-5-31/87667089.jpg">
<meta property="og:image" content="http://p8urkh0xe.bkt.clouddn.com/18-5-31/35258433.jpg">
<meta property="og:updated_time" content="2018-07-24T21:01:04.746Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ssh安全加固">
<meta name="twitter:description" content="每一台服务器基本都会配置ssh服务，但是如果我们不对ssh进行安全防护，就相当于给入侵者提供了一个入侵途径。所以对ssh进行一些安全配置十分重要。">
<meta name="twitter:image" content="http://p8urkh0xe.bkt.clouddn.com/18-5-31/87667089.jpg">
  
    <link rel="alternative" href="/atom.xml" title="Peithon&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="http://p8urkh0xe.bkt.clouddn.com/touxiang.jpg">
  
  <link rel="stylesheet" href="/css/style.css">
  
<script>
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
        }
        else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

  

  <script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>
  <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>

  
      <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
<script>AV.initialize("YV6LWh5W8UQ3bQKoo628fNVK-gzGzoHsz", "SnDWsQ8dkIu3YguxR8PB7ok5");</script>
<script src="/js/Counter.js"></script>

  
</head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://p8urkh0xe.bkt.clouddn.com/touxiang.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Peithon</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">归档</a></li>
				        
							<li><a href="/about">关于</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/CentOS7/" style="font-size: 10px;">CentOS7</a> <a href="/tags/Centos7网络配置/" style="font-size: 10px;">Centos7网络配置</a> <a href="/tags/Docker网络模式/" style="font-size: 10px;">Docker网络模式</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/Linux内核/" style="font-size: 10px;">Linux内核</a> <a href="/tags/ftp常用命令/" style="font-size: 10px;">ftp常用命令</a> <a href="/tags/ftp的搭建/" style="font-size: 10px;">ftp的搭建</a> <a href="/tags/kvm虚拟化/" style="font-size: 10px;">kvm虚拟化</a> <a href="/tags/lnmp搭建/" style="font-size: 10px;">lnmp搭建</a> <a href="/tags/sql文件导出和导入/" style="font-size: 10px;">sql文件导出和导入</a> <a href="/tags/ssh安全加固/" style="font-size: 10px;">ssh安全加固</a> <a href="/tags/ssh服务/" style="font-size: 10px;">ssh服务</a> <a href="/tags/tigervnc安装/" style="font-size: 10px;">tigervnc安装</a> <a href="/tags/vhosts/" style="font-size: 10px;">vhosts</a> <a href="/tags/virsh常用命令/" style="font-size: 10px;">virsh常用命令</a> <a href="/tags/多端口/" style="font-size: 10px;">多端口</a> <a href="/tags/容器端口转发/" style="font-size: 10px;">容器端口转发</a> <a href="/tags/密钥登录/" style="font-size: 10px;">密钥登录</a> <a href="/tags/建立虚拟用户/" style="font-size: 10px;">建立虚拟用户</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://cherrygk.github.io/">cherrygk渗透大佬</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://ssssdl.github.io">ssssdl XSS大佬</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Peithon</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://p8urkh0xe.bkt.clouddn.com/touxiang.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">Peithon</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">归档</a></li>
		        
					<li><a href="/about">关于</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-ssh-safety" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/05/31/ssh-safety/" class="article-date">
  	<time datetime="2018-05-31T07:46:21.000Z" itemprop="datePublished">2018-05-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ssh安全加固
      
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ssh安全加固/">ssh安全加固</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/密钥登录/">密钥登录</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Linux/">Linux</a>
	</div>


        
          
<div class="counter-tag counter">
    <span id="/2018/05/31/ssh-safety/" class="leancloud_visitors post-title-link"
          style="font-size: 12px" data-flag-title="ssh安全加固">
         &nbsp;
        view
    </span>
</div>

        
        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>每一台服务器基本都会配置ssh服务，但是如果我们不对ssh进行安全防护，就相当于给入侵者提供了一个入侵途径。所以对ssh进行一些安全配置十分重要。<br><a id="more"></a></p>
<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>ssh服务的配置文件:<code>/etc/ssh/sshd_config</code></p>
<p>ssh日志文件:<code>/var/log/secure</code></p>
<h2 id="0x01-更换ssh服务的端口"><a href="#0x01-更换ssh服务的端口" class="headerlink" title="0x01 更换ssh服务的端口"></a>0x01 更换ssh服务的端口</h2><p>ssh服务默认是22端口，修改的时候如果系统的SELinux是开启的话是不会成功的，会报以下的端口错误。</p>
<p><img src="http://p8urkh0xe.bkt.clouddn.com/18-5-31/87667089.jpg" alt=""></p>
<p>因为SELinux开启时ssh不能在另一个端口运行</p>
<p>1).检查允许监听哪些端口sshd</p>
<pre><code>$ semanage port -l | grep ssh
ssh_port_t                     tcp      22
</code></pre><p>2).关闭SELinux或者添加一条规则</p>
<p>a.关闭SELinux</p>
<pre><code>$ sudo vi /etc/selinux/config
#SELINUX=enforcing #注释掉
#SELINUXTYPE=targeted #注释掉
SELINUX=disabled #增加
#保存退出
</code></pre><p>执行命令使配置生效</p>
<pre><code>$ sudo setenforce 0
</code></pre><p>b.添加规则</p>
<pre><code>$ sudo semanage port -a -t ssh_port_t -p tcp 30102
</code></pre><p>若<code>semanage</code>命令不可以，使用命令<code>yum install -y policycoreutils-python</code>安装<code>policycoreutils-python</code>包</p>
<p>3).修改端口号(17行)</p>
<pre><code>$ sudo vi /etc/ssh/sshd_config
 17  Port 30102
</code></pre><p>4).重启ssh服务</p>
<pre><code>$ systemctl restart sshd
</code></pre><p>5).测试30102是否可用</p>
<pre><code>$ ssh -p 30102 localhost
</code></pre><p>6).在防火墙把22端口关闭</p>
<pre><code>$ sudo firewall-cmd --remove-port=22/tcp --permanent
</code></pre><p>–permanent表示永久生效，重启不会丢失配置</p>
<p>7).重新加载配置</p>
<pre><code>$ sudo firewall-cmd --reload
</code></pre><p>8).查看22端口的开放情况</p>
<pre><code>$ sudo firewall-cmd --query-port=22/tcp
no
</code></pre><p>9).防火墙开放30102端口</p>
<pre><code>$ sudo firewall-cmd --add-port=30102/tcp --permanent
$ sudo firewall-cmd --reload
$ systemctl restart sshd
</code></pre><p>10).其他主机即可通过30102端口远程此电脑</p>
<pre><code>#查看开放的所有端口
$ sudo firewall-cmd --zone=public --list-ports
</code></pre><h2 id="0x02-改变ssh版本"><a href="#0x02-改变ssh版本" class="headerlink" title="0x02 改变ssh版本"></a>0x02 改变ssh版本</h2><p>目前存在两种SSH（版本1和版本2）。Red Hat Enterprise Linux下的OpenSSH套件使用SSH版本2，该版本具有增强的密钥交换算法，不易受到版本1中的攻击。修改配置文件第23行。</p>
<pre><code>23 Protocol 2
</code></pre><h2 id="0x03-禁止root登录"><a href="#0x03-禁止root登录" class="headerlink" title="0x03 禁止root登录"></a>0x03 禁止root登录</h2><p>使用其他用户登录，这样既较低了用户权限，同时其他用户的账号攻击者还得猜解，这大大增加了攻击难度。修改配置文件49行</p>
<pre><code>49 PermitRootLogin no
</code></pre><h2 id="0x04-通过密钥登录"><a href="#0x04-通过密钥登录" class="headerlink" title="0x04 通过密钥登录"></a>0x04 通过密钥登录</h2><p>不允许密码登录，利用密钥生成器制作一对密钥——一只公钥和一只私钥。将公钥添加到服务器的某个账户上，然后在客户端利用私钥即可完成认证并登录。可以有效防止SSH暴力破解。如果将公钥复制到其他账户甚至主机，利用私钥也可以登录。或者<a href="https://linux.cn/article-3725-1.html" target="_blank" rel="noopener">采用双因子认证</a>。 </p>
<pre><code>#修改配置文件77行,先允许密码登录，后面的步骤需要远程下载私钥文件
$ sudo vi /etc/ssh/sshd_config
77 PasswordAuthentication yes
#允许密钥登录,54、55行
54 RSAAuthentication yes
55 PubkeyAuthentication yes
#保存退出
</code></pre><h3 id="1-制作密钥对"><a href="#1-制作密钥对" class="headerlink" title="1).制作密钥对"></a>1).制作密钥对</h3><p>密码登录到打算使用密钥登录的账户,建立密钥对</p>
<pre><code>$ ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (/home/admin/.ssh/id_rsa):   回车
Enter passphrase (empty for no passphrase):    输入密钥锁码，或直接按 Enter 留空
Enter same passphrase again:    确认密钥锁码
Your identification has been saved in /home/admin/.ssh/id_rsa.    &lt;== 私钥
Your public key has been saved in /home/admin/.ssh/id_rsa.pub.    &lt;== 公钥
The key fingerprint is:
b7:af:ce:02:0d:d0:8d:64:80:11:13:1f:ed:c9:4f:5e admin@localhost.localdomain
The key&apos;s randomart image is:
+--[ RSA 2048]----+
|  ==o=oo         |
|  .o.o+ .        |
|    .+ .         |
|      = . E      |
|       *S..      |
|      . +. .     |
|       .  .      |
|        .. .     |
|         o+..    |
+-----------------+
</code></pre><p>密钥锁码在使用私钥时必须输入，这样就可以保护私钥不被盗用。当然，也可以留空，实现无密码登录。</p>
<p>在admin用户的家目录中生成了一个 .ssh 的隐藏目录，内含两个密钥文件。id_rsa 为私钥，id_rsa.pub 为公钥</p>
<h3 id="2-在服务器配置公钥"><a href="#2-在服务器配置公钥" class="headerlink" title="2).在服务器配置公钥"></a>2).在服务器配置公钥</h3><pre><code>$ cd .ssh
$ cat id_rsa.pub &gt;&gt; authorized_keys
$ chmod 600 authorized_keys
$ chmod 700 ~/.ssh
$systemctl restart sshd
</code></pre><h3 id="3-下载密钥-id-rsa-文件到本地"><a href="#3-下载密钥-id-rsa-文件到本地" class="headerlink" title="3).下载密钥(id_rsa)文件到本地"></a>3).下载密钥(id_rsa)文件到本地</h3><h3 id="4-修改配置文件-不允许密码登录"><a href="#4-修改配置文件-不允许密码登录" class="headerlink" title="4).修改配置文件,不允许密码登录"></a>4).修改配置文件,不允许密码登录</h3><pre><code>$ sudo vi /etc/ssh/sshd_config
77 PasswordAuthentication yes
#保存退出
$ systemctl restart sshd
</code></pre><h3 id="5-使用Xshell远程连接"><a href="#5-使用Xshell远程连接" class="headerlink" title="5).使用Xshell远程连接"></a>5).使用Xshell远程连接</h3><p><img src="http://p8urkh0xe.bkt.clouddn.com/18-5-31/35258433.jpg" alt=""></p>
<p>浏览-&gt;文件-&gt;选择id_rsa-&gt;输入密钥锁码-&gt;确认即可连接</p>
<h2 id="0x05-设置黑白名单"><a href="#0x05-设置黑白名单" class="headerlink" title="0x05 设置黑白名单"></a>0x05 设置黑白名单</h2><p>通过设置黑白名单可以限制访问,这样可以大大提高安全性</p>
<h3 id="限制用户"><a href="#限制用户" class="headerlink" title="限制用户"></a>限制用户</h3><h4 id="1-设置登录用户白名单"><a href="#1-设置登录用户白名单" class="headerlink" title="1).设置登录用户白名单"></a>1).设置登录用户白名单</h4><p>在<code>/etc/ssh/sshd_config</code>配置文件中设置AllowUsers选项</p>
<pre><code># 允许testadmin和从192.168.0.1 登录的test帐户通过SSH登录系统。
AllowUsers    testadmin   test@192.168.0.1
</code></pre><h4 id="2-设置登录用户黑名单"><a href="#2-设置登录用户黑名单" class="headerlink" title="2).设置登录用户黑名单"></a>2).设置登录用户黑名单</h4><p>在<code>/etc/ssh/sshd_config</code>配置文件中设置DenyUsers选项</p>
<pre><code>#不允许testadmin用户登录系统
DenyUsers testadmin
</code></pre><h3 id="限制IP"><a href="#限制IP" class="headerlink" title="限制IP"></a>限制IP</h3><h4 id="1-设置IP白名单"><a href="#1-设置IP白名单" class="headerlink" title="1).设置IP白名单"></a>1).设置IP白名单</h4><p>在<code>/etc/hosts.allow</code>中添加IP</p>
<pre><code>$ sudo vi /etc/hosts.allow
#
# hosts.allow   This file contains access rules which are used to
#               allow or deny connections to network services that
#               either use the tcp_wrappers library or that have been
#               started through a tcp_wrappers-enabled xinetd.
#
#               See &apos;man 5 hosts_options&apos; and &apos;man 5 hosts_access&apos;
#               for information on rule syntax.
#               See &apos;man tcpd&apos; for information on tcp_wrappers
sshd:192.168.0.1:allow
sshd:192.168.0.1/24:allow
</code></pre><p>在上面文件中添加了两个内容</p>
<pre><code>sshd:192.168.0.1:allow      #允许IP192.168.0.1登录ssh
sshd:192.168.0.1/24:allow   #允许192.168.0.1/24这段IP的用户登录ssh
</code></pre><h4 id="2-设置IP黑名单"><a href="#2-设置IP黑名单" class="headerlink" title="2).设置IP黑名单"></a>2).设置IP黑名单</h4><pre><code>$ sudo vi /etc/hosts.deny

#
# hosts.deny    This file contains access rules which are used to
#               deny connections to network services that either use
#               the tcp_wrappers library or that have been
#               started through a tcp_wrappers-enabled xinetd.
#
#               The rules in this file can also be set up in
#               /etc/hosts.allow with a &apos;deny&apos; option instead.
#
#               See &apos;man 5 hosts_options&apos; and &apos;man 5 hosts_access&apos;
#               for information on rule syntax.
#               See &apos;man tcpd&apos; for information on tcp_wrappers
sshd:ALL    #拒绝全部的ssh登录
</code></pre><h4 id="3-hosts-allow-和hosts-deny-两个文件同时设置规则的时候，hosts-allow-文件中的规则优先级高"><a href="#3-hosts-allow-和hosts-deny-两个文件同时设置规则的时候，hosts-allow-文件中的规则优先级高" class="headerlink" title="3).hosts.allow 和hosts.deny 两个文件同时设置规则的时候，hosts.allow 文件中的规则优先级高"></a>3).hosts.allow 和hosts.deny 两个文件同时设置规则的时候，hosts.allow 文件中的规则优先级高</h4><h2 id="0x06-设置多长时间没有成功连接上就断线"><a href="#0x06-设置多长时间没有成功连接上就断线" class="headerlink" title="0x06 设置多长时间没有成功连接上就断线"></a>0x06 设置多长时间没有成功连接上就断线</h2><p>默认的等待时间为 2 分钟，如果没有单位将以秒作为单位，可用的单位分别为 h，m、s，时间越短越安全。</p>
<pre><code>$ sudo vi /etc/ssh/sshd_config
48 LoginGraceTime 30s
#保存退出
$systemctl restart sshd
</code></pre><h2 id="0x07-配置Fail2ban、denyhosts等"><a href="#0x07-配置Fail2ban、denyhosts等" class="headerlink" title="0x07 配置Fail2ban、denyhosts等"></a>0x07 配置Fail2ban、denyhosts等</h2><p>当因为某些需要不得不使用密码登录时，使用Fail2ban可以缓解ssh服务器的暴力破解,通过配置Fail2ban来自动屏蔽针对SSH,HTTP等各服务的暴力密码猜解或者DDOS攻击等,降低暴力破解对服务器造成的威胁。</p>
<h3 id="未经本人允许，禁止转载"><a href="#未经本人允许，禁止转载" class="headerlink" title="*未经本人允许，禁止转载"></a>*未经本人允许，禁止转载</h3>
      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/06/03/linux-kernel/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">&lt;</strong>
      <div class="article-nav-title">
        
          Linux内核引发的Docker安装失败问题
        
      </div>
    </a>
  
  
    <a href="/2018/05/28/lnmp-setup/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">使用源代码搭建LNMP动态网站</div>
      <strong class="article-nav-caption">&gt;</strong>
    </a>
  
</nav>

  
</article>






</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2018 Peithon
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="/js/main.js"></script>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js"></script>


  </div>
</body>
</html>